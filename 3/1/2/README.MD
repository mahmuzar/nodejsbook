–ü—Ä–∏–º–µ—Ä –º–∏–∫—Ä–æ—Å–µ—Ä–≤–∏—Å–∞ –Ω–∞ TypeScript —Å –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ–º Kafka, DLQ, –∞—Å–∏–Ω—Ö—Ä–æ–Ω–Ω–æ–π –æ–±—Ä–∞–±–æ—Ç–∫–æ–π –∏ —á–∏—Å—Ç–æ–π –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–æ–π, –≤–∫–ª—é—á–∞—è:

–ó–∞–¥–∞—á–∞ –ø–æ–∫–∞–∑–∞—Ç—å —Ä–∞–±–æ—Ç—É —Å –∫–∞—Ñ–∫–æ–π
____

- –¢–æ—á–∫—É –≤—Ö–æ–¥–∞ main.ts
- –í—ã–¥–µ–ª–µ–Ω–Ω—ã–π HTTP-–º–æ–¥—É–ª—å app.ts
- –û—Ç–¥–µ–ª—å–Ω—ã–µ Kafka-–º–æ–¥—É–ª–∏: producer.ts –∏ consumer.ts
- –ü–æ–¥–¥–µ—Ä–∂–∫—É graceful shutdown
- –ì–æ—Ç–æ–≤–Ω–æ—Å—Ç—å –∫ —Å–æ–±–µ—Å–µ–¥–æ–≤–∞–Ω–∏—é

## –°–æ–¥–µ—Ä–∂–∞–Ω–∏–µ

1. [–°—Ç—Ä—É–∫—Ç—É—Ä–∞ –ø—Ä–æ–µ–∫—Ç–∞](#--–°—Ç—Ä—É–∫—Ç—É—Ä–∞-–ø—Ä–æ–µ–∫—Ç–∞)
2. [–£—Å—Ç–∞–Ω–æ–≤–∫–∞ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π](#-–£—Å—Ç–∞–Ω–æ–≤–∫–∞-–∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π)
3. [tsconfig.json](#-tsconfigjson)
4. [src/types.ts ‚Äî —Ç–∏–ø—ã —Å–æ–±—ã—Ç–∏–π](#-srctypests--—Ç–∏–ø—ã-—Å–æ–±—ã—Ç–∏–π)
5. [src/server.ts ‚Äî HTTP API (Producer)](#-srcserverts--HTTP-API-producer)
6. [src/consumer.ts ‚Äî Worker](#-srcconsumerts--Worker)
7. [–û–±–Ω–æ–≤–ª–µ–Ω–∏–µ package.json ‚Äî —Å–∫—Ä–∏–ø—Ç—ã](#-–û–±–Ω–æ–≤–ª–µ–Ω–∏–µ-packagejson--—Å–∫—Ä–∏–ø—Ç—ã)
8. [–ó–∞–ø—É—Å–∫ –≤ —Ä–µ–∂–∏–º–µ —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∏](#-–ó–∞–ø—É—Å–∫-–≤-—Ä–µ–∂–∏–º–µ-—Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∏)
8. [–¢–µ—Å—Ç](#-–¢–µ—Å—Ç)

## [‚Üë](#–°–æ–¥–µ—Ä–∂–∞–Ω–∏–µ) üìÅ –°—Ç—Ä—É–∫—Ç—É—Ä–∞ –ø—Ä–æ–µ–∫—Ç–∞

```csv
kafka-async-service/
‚îú‚îÄ‚îÄ src/
‚îÇ   ‚îú‚îÄ‚îÄ types.ts
‚îÇ   ‚îú‚îÄ‚îÄ app.ts
‚îÇ   ‚îú‚îÄ‚îÄ main.ts
‚îÇ   ‚îî‚îÄ‚îÄ kafka/
‚îÇ       ‚îú‚îÄ‚îÄ producer.ts
‚îÇ       ‚îî‚îÄ‚îÄ consumer.ts
‚îú‚îÄ‚îÄ package.json
‚îú‚îÄ‚îÄ tsconfig.json
‚îî‚îÄ‚îÄ docker-compose.yml  (–æ—Å—Ç–∞—ë—Ç—Å—è –±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π)
```

## [‚Üë](#–°–æ–¥–µ—Ä–∂–∞–Ω–∏–µ) –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π

```bash
npm init -y
npm install kafkajs express
npm install -D typescript ts-node @types/express @types/node
```

## [‚Üë](#–°–æ–¥–µ—Ä–∂–∞–Ω–∏–µ) tsconfig.json

```json
{
  "compilerOptions": {
    "target": "ES2021",
    "module": "commonjs",
    "esModuleInterop": true,
    "strict": true,
    "skipLibCheck": true,
    "outDir": "./dist",
    "rootDir": "./src",
    "resolveJsonModule": true
  },
  "include": ["src/**/*"],
  "exclude": ["node_modules"]
}
```

## [‚Üë](#–°–æ–¥–µ—Ä–∂–∞–Ω–∏–µ) src/types.ts ‚Äî —Ç–∏–ø—ã —Å–æ–±—ã—Ç–∏–π

```ts
export interface NotificationEvent {
  userId: string;
  message: string;
  timestamp: number;
  eventId: string;
}

export interface DlqMessage {
  originalTopic: string;
  partition: number;
  offset: string;
  error: {
    message: string;
    stack?: string;
    timestamp: number;
  };
  payload: unknown;
  retryCount: number;
}
```

## [‚Üë](#–°–æ–¥–µ—Ä–∂–∞–Ω–∏–µ) src/server.ts ‚Äî HTTP API (Producer)

```ts
// src/server.ts
import express, { Request, Response } from 'express';
import { Kafka } from 'kafkajs';
import { NotificationEvent } from './types';

const app = express();
app.use(express.json());

// Kafka setup
const kafka = new Kafka({
  clientId: 'notification-producer',
  brokers: ['localhost:9092'],
});

const producer = kafka.producer();

// –ü–æ–¥–∫–ª—é—á–∞–µ–º –ø—Ä–æ–¥—é—Å–µ—Ä–∞ –ø—Ä–∏ —Å—Ç–∞—Ä—Ç–µ
producer.connect().catch(console.error);

// –≠–Ω–¥–ø–æ–∏–Ω—Ç –¥–ª—è –æ—Ç–ø—Ä–∞–≤–∫–∏ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è
app.post('/notify', async (req: Request, res: Response) => {
  const { userId, message }: { userId?: string; message?: string } = req.body;

  if (!userId || !message) {
    return res.status(400).json({ error: 'userId and message are required' });
  }

  const event: NotificationEvent = {
    userId,
    message,
    timestamp: Date.now(),
    eventId: Math.random().toString(36).substring(2, 15),
  };

  try {
    await producer.send({
      topic: 'user.notifications',
      messages: [{ value: JSON.stringify(event) }],
    });

    console.log('Sent event:', event.eventId);
    return res.status(202).json({ status: 'accepted', eventId: event.eventId });
  } catch (err) {
    console.error('Failed to send to Kafka:', err);
    return res.status(500).json({ error: 'Failed to queue notification' });
  }
});

const PORT = 3000;
app.listen(PORT, () => {
  console.log(`Producer API running on http://localhost:${PORT}`);
});
```

## [‚Üë](#–°–æ–¥–µ—Ä–∂–∞–Ω–∏–µ) src/consumer.ts ‚Äî Worker

```ts
// src/consumer.ts
import { Kafka, EachMessagePayload } from 'kafkajs';
import { NotificationEvent } from './types';

const kafka = new Kafka({
  clientId: 'notification-consumer',
  brokers: ['localhost:9092'],
});

const consumer = kafka.consumer({ groupId: 'notification-group' });

async function simulateNotification(event: NotificationEvent): Promise<void> {
  // –ò–º–∏—Ç–∞—Ü–∏—è –æ—Ç–ø—Ä–∞–≤–∫–∏ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è
  await new Promise((resolve) => setTimeout(resolve, 1000));
  console.log(`Sending "${event.message}" to user ${event.userId}`);
}

async function run(): Promise<void> {
  await consumer.connect();
  await consumer.subscribe({ topic: 'user.notifications', fromBeginning: false });

  await consumer.run({
    eachMessage: async ({ topic, partition, message }: EachMessagePayload) => {
      if (!message.value) {
        console.warn('Received empty message');
        return;
      }

      const event: NotificationEvent = JSON.parse(message.value.toString());
      console.log(`Processing event ${event.eventId} from partition ${partition}`);

      try {
        await simulateNotification(event);
        console.log(`Processed event ${event.eventId}`);
      } catch (err) {
        console.error(`Failed to process event ${event.eventId}:`, (err as Error).message);
        // –ë—Ä–æ—Å–∞–µ–º –æ—à–∏–±–∫—É ‚Üí offset –Ω–µ –∫–æ–º–º–∏—Ç–∏—Ç—Å—è ‚Üí Kafka –ø–æ–≤—Ç–æ—Ä–∏—Ç —Å–æ–æ–±—â–µ–Ω–∏–µ
        throw err;
      }
    },
  });
}

// Graceful shutdown
process.on('SIGINT', async () => {
  console.log('Shutting down consumer...');
  await consumer.disconnect();
  process.exit(0);
});

run().catch(console.error);
```

## [‚Üë](#–°–æ–¥–µ—Ä–∂–∞–Ω–∏–µ) –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ package.json ‚Äî —Å–∫—Ä–∏–ø—Ç—ã

```json
{
  "name": "kafka-notification-service",
  "scripts": {
    "build": "tsc",
    "start:api": "ts-node src/main.ts",
    "start:consumer": "ts-node src/kafka/consumer.ts"
  }
}
```

## [‚Üë](#–°–æ–¥–µ—Ä–∂–∞–Ω–∏–µ) –ó–∞–ø—É—Å–∫ –≤ —Ä–µ–∂–∏–º–µ —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∏

```bash
# –¢–µ—Ä–º–∏–Ω–∞–ª 1: API
npm run start:api

# –¢–µ—Ä–º–∏–Ω–∞–ª 2: Consumer
npm run start:consumer
```

## [‚Üë](#–°–æ–¥–µ—Ä–∂–∞–Ω–∏–µ) –¢–µ—Å—Ç:

```bash
curl -X POST http://localhost:3000/notify \
  -H "Content-Type: application/json" \
  -d '{"userId": "murad", "message": "–ü—Ä–∏–≤–µ—Ç –∏–∑ TypeScript!"}'
```